<div class="page-header">
  <div class="title-area">
    <h2>Gestión de Vehículos</h2>
    <p class="subtitle">Administra tu flota activa</p>
  </div>

  <button class="btn-primary" routerLink="nuevo">
    <span class="icon-wrapper">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="16"></line>
        <line x1="8" y1="12" x2="16" y2="12"></line>
      </svg>
    </span>
    Nuevo Vehículo
  </button>
</div>

<div class="controls-section">
  <div class="toggles-row">
    <span class="helper-text">Vista:</span>
    <div class="view-toggles">
      <button [class.active]="viewMode() === 'list'" (click)="setViewMode('list')" title="Vista de Lista">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
          stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
        </svg>
      </button>
      <button [class.active]="viewMode() === 'grid'" (click)="setViewMode('grid')" title="Vista de Cuadrícula">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
          class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
        </svg>

      </button>
    </div>
  </div>

  <div class="search-wrapper">
    <span class="icon-search">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </span>
    <input type="text" [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)"
      placeholder="Buscar por placa, marca o modelo...">
  </div>
</div>

<div class="table-container" *ngIf="viewMode() === 'list'">
  <table>
    <thead>
      <tr>
        <th>Placa</th>
        <th>Vehículo</th>
        <th>Kilometraje</th>
        <th>Servicio</th>
        <th>Estado</th>
        <th class="text-end">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let v of vehiculosFiltrados()">
        <td class="fw-bold highlight">{{ v.placa }}</td>
        <td>
          <div class="vehicle-info">
            <img [src]="v.fotoUrl || 'assets/placeholder-car.png'" alt="Car" class="mini-img">
            <span>{{ v.marca }} {{ v.modelo }} ({{v.anio}})</span>
          </div>
        </td>
        <td>{{ v.kilometrajeActual | number }} km</td>
        <td class="text-muted">{{ v.intervaloServicioKm | number }} km</td>
        <td><app-semaforo-badge [estado]="v.estado"></app-semaforo-badge></td>
        <td class="actions text-end">
          <button (click)="checkStatus(v.id)" class="btn-icon" title="Ver Semáforo">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 12 12"><path fill="currentColor" fill-rule="evenodd" d="M12 6A6 6 0 1 1 0 6a6 6 0 0 1 12 0M5 3a1 1 0 0 1 2 0v3a1 1 0 0 1-2 0zm1 5a1 1 0 1 0 0 2a1 1 0 0 0 0-2" clip-rule="evenodd"/></svg>
          </button>
          <button (click)="editVehiculo(v.id)" class="btn-icon" title="Editar">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
            </svg>
          </button>
          <button (click)="deleteVehiculo(v.id)" class="btn-icon danger" title="Eliminar">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6" />
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
              <line x1="10" y1="11" x2="10" y2="17" />
              <line x1="14" y1="11" x2="14" y2="17" />
            </svg>
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div class="grid-container" *ngIf="viewMode() === 'grid'">
  <div class="vehicle-card" *ngFor="let v of vehiculosFiltrados()">
    <div class="card-header">
      <span class="placa">{{ v.placa }}</span>
      <app-semaforo-badge [estado]="v.estado"></app-semaforo-badge>
    </div>
    <div class="card-image">
      <img [src]="v.fotoUrl || 'assets/default-car.png'" alt="Foto vehículo">
    </div>
    <div class="card-body">
      <h3>{{ v.marca }} {{ v.modelo }}</h3>
      <p class="year">{{ v.anio }}</p>
      <div class="stats">
        <div class="stat"><small>Actual</small><strong>{{ v.kilometrajeActual | number }} km</strong></div>
        <div class="stat"><small>Meta</small><strong>{{ v.intervaloServicioKm | number }} km</strong></div>
      </div>
    </div>
    <div class="card-actions">
      <button (click)="checkStatus(v.id)" class="btn-icon" title="Ver Semáforo">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 12 12"><path fill="currentColor" fill-rule="evenodd" d="M12 6A6 6 0 1 1 0 6a6 6 0 0 1 12 0M5 3a1 1 0 0 1 2 0v3a1 1 0 0 1-2 0zm1 5a1 1 0 1 0 0 2a1 1 0 0 0 0-2" clip-rule="evenodd"/></svg>
      </button>
      <button (click)="editVehiculo(v.id)" class="btn-icon" title="Editar">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
        </svg>
      </button>
      <button (click)="deleteVehiculo(v.id)" class="btn-icon danger" title="Eliminar">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6" />
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
          <line x1="10" y1="11" x2="10" y2="17" />
          <line x1="14" y1="11" x2="14" y2="17" />
        </svg>
      </button>
    </div>
  </div>
</div>

<div *ngIf="vehiculosFiltrados().length === 0" class="empty-state">
  <p>No se encontraron vehículos.</p>
</div>

<app-modal *ngIf="modalOpen()" [title]="modalType() === 'payment' ? 'Registrar Pago' : 'Diagnóstico de Servicio'"
  [showFooter]="false" (onClose)="closeModal()">

  <div *ngIf="modalType() === 'status'" class="status-detail">

    <div *ngIf="!selectedStatus()" class="loader-container">
      <div class="spinner"></div>
      <p>Cargando diagnóstico...</p>
    </div>

    <div *ngIf="selectedStatus()" class="status-card" [ngClass]="selectedStatus()!.color.toLowerCase()">

      <div class="status-icon-wrapper">
        <ng-container [ngSwitch]="selectedStatus()!.color">
          <svg *ngSwitchCase="'ROJO'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          <svg *ngSwitchCase="'AMARILLO'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
            </path>
          </svg>
          <svg *ngSwitchDefault xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </ng-container>
      </div>

      <div class="status-content">
        <h4>{{ selectedStatus()!.mensaje }}</h4>
        <div class="metric-box">
          <span class="label">Diferencia de Km</span>
          <span class="value">{{ selectedStatus()!.kmRestantes | number }} km</span>
        </div>
      </div>

      <div class="status-actions">
        
        <button 
          *ngIf="selectedStatus()?.color === 'ROJO' && getSelectedVehiculoEstado() !== 2" 
          class="btn-action btn-danger" 
          (click)="sendToMaintenance()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
          Enviar a Taller
        </button>

        <button 
          *ngIf="getSelectedVehiculoEstado() === 2 || selectedStatus()?.color === 'AMARILLO' || selectedStatus()?.color === 'NARANJA'" 
          class="btn-action btn-primary" 
          (click)="payService()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
          Registrar Pago y Liberar
        </button>

      </div>

    </div>
  </div>

  <div *ngIf="modalType() === 'payment'" class="payment-form">
    <p class="instruction">Ingresa el monto total de la factura para liberar el vehículo.</p>

    <div class="input-currency-wrapper">
      <span class="symbol">$</span>
      <input type="number" [ngModel]="paymentAmount()" (ngModelChange)="paymentAmount.set($event)" placeholder="0.00"
        autofocus>
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeModal()">Cancelar</button>
      <button class="btn-pay-confirm" (click)="confirmPayment()">Confirmar Pago</button>
    </div>
  </div>

</app-modal>